# 社团管理系统 - 功能设计说明书

本项目旨在解决高校社团日常管理中的痛点，交付一套轻量级的社团管理系统。

### 1. 项目概览与范围
| 类别 | 描述 |
| :--- | :--- |
| **项目目标** | 交付一套“校内网可用、社长可维护、一页就能看懂”的轻量级社团管理系统。 |
| **项目范围** | PC 网页版，仅支持**单社团**管理。 |
| **核心功能** | 社员档案、部门管理、活动管理（含多签审批流）、统计报表、导出交接包。 |
| **技术栈** | **后端:** SpringBoot 2.7 + MyBatisPlus + Swagger3 + JWT   **前端:** Vue2 + VueRouter + Vuex + ElementUI + vue-admin-template |
| **部署环境** | 学校内网局域网（HTTP 协议）。 |


### 2. 角色与权限模型
| 角色 | 查看全员档案 | 编辑档案 | 查看全部活动 | 创建/编辑活动 | 审批活动 | 导出数据 | 后台管理 | 特殊权限/说明 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **社长** | ✔ | ✔ | ✔ | ✔ | ✔ | ✔ | ✔ | **全权限**，含后台账号管理、部门/角色/晋升调动。 |
| **副社长** | ✔ | ✔ | ✔ | ✔ | ✔ | ✔ | ❌ | 同社长，仅不含“后台账号管理”。 |
| **部长** | ✔ | **仅本部门** | ✔ | ✔ (**负责方**) | ❌ | ✔ | ❌ | **不可**修改成员的部门/角色；活动创建/编辑权限限定为其负责的活动。 |
| **副部长** | ✔ | ❌ | ✔ | ❌ | ❌ | ✔ | ❌ | 仅查看，可导出。 |
| **干事** | **仅自己** | **仅自己** | ✔ | ❌ | ❌ | ❌ | ❌ | 仅查看和编辑自己档案，查看已发布活动。 |
| **指导老师** | ✔ | ❌ | ✔ | ❌ | ✔ | ✔ | ❌ | **仅可审批活动**，**不可**维护社员档案、部门管理、活动参与记录。 |


+ **权限约束确认：** 部长**不能**修改本部门成员的部门和角色字段。所有涉及成员的部门/角色变更（晋升、调动）**只能**由**社长、副社长、指导老师**完成。
+ **档案敏感信息：** 所有拥有“查看全员档案”权限的角色（社长/副社长/部长/副部长/指导老师）均可查看**手机、邮箱**等敏感信息。
+ **账号来源：** 账号在 `member` 表中统一管理，`sys_user` 仅用于保留超管或其他未来多社团扩展。

### 3. 数据模型（核心表调整）
根据多轮确认，核心表结构（使用逻辑外键）调整如下：

| 表名 | 字段（调整/新增部分加粗） | 字段说明 | 索引/约束 |
| :--- | :--- | :--- | :--- |
| `member` | id, stu_id, name, gender, college, major, grade, phone, email, join_date, dept_id, **role** (**中文名**), photo_oss_key, password, create_by, create_time, update_time, **leave****_****date** | **role**：存储中文名称（如“社长”）。   **leave****_****date**：离社时间，用于精确统计历史人数。 | `stu_id` 唯一 |
| `dept` | id, name, sort, **intro** | **intro**：部门简介（VARCHAR 500）。 |  |
| `activity` | id, name, start_time, end_time, location, type, **description**, status【0待审/1通过/2驳回】, reject_reason, **create****_****by** (发起人 id), create_time, update_time | **description**：活动简介（富文本）。   **leader****_****id 字段已移除。** | `start_time` |
| `activity_member` | id, activity_id, member_id, create_time | 活动参与人员记录。 | `activity_id` + `member_id` 联合唯一 |
| `activity_approver` | id, activity_id, user_id (审批人), create_time, **status** (0待审/1通过/2驳回), **approval****_****time** | **新增**：活动与审批人关系表，支持多签流状态记录。 | `activity_id` + `user_id` 联合唯一 |
| `activity_dept` | id, activity_id, dept_id, create_time | **新增**：活动与负责部门关系表，支持多部门负责。 | `activity_id` + `dept_id` 联合唯一 |
| `activity_attachment` | id, activity_id, file_name, original_name, file_path, file_size, file_type, file_ext, upload_by, upload_time, description, download_count | **新增**：活动附件表，支持文件上传、下载、预览、删除等功能。 | `activity_id` 索引 |
| `sys_user` | id, stu_id, name, role, password, status, create_time | **定位：** 仅用于超管账号，与 `member` 分离。 |  |
| `sys_log` | id, operator, operation, method, params, ip, create_time | 关键操作日志。 |  |


### 4. 核心功能与逻辑流程
#### 4.1. 登录与安全
+ **锁定机制：** 登录失败 5 次锁定 30 分钟。**锁定期结束后**，失败计数器立即**重置为 0**。
+ **密码存储：** bcyrpt(10) 存储；JWT 秘钥 256-bit 随机。
+ **活动参与管理：** 支持活动报名、取消报名、参与人员实时管理，确保数据一致性。
+ **统一认证：** 支持系统管理员和社团成员两种用户类型，优先使用member表认证。

#### 4.2. 社员档案（数据完整性保障）
+ **批量导入：**
    - **异常处理：** 空学号/重复学号/非法日期（格式不符或 `join_date` 晚于当前日期）标红并阻止导入。

#### 4.3. 部门管理
+ **部门删除校验：** 仅校验 `member` 表中无成员关联。**不考虑** `activity_dept` 历史活动记录。删除功能仅在部门详情页面提供。
+ **部门信息：** 新增 `intro` 字段，支持“卡片视图”展示。

#### 4.4. 活动管理（多签审批流）
+ **负责方：** `activity_dept` 表记录负责部门，由创建者确定。
+ **部长权限控制：** 部长只能创建和编辑本部门负责的活动，负责部门字段默认显示并固定为本部门。
+ **活动报名权限：** 只有已通过的活动（status=1）才能报名，待审批和已驳回的活动用户不能报名，但有管理权限的人仍可以添加参与人员。
+ **审批流（多签）：**
    1. **审批人：** 限制为指导老师或社长，由创建者多选，记录在 `activity_approver` 表。
    2. **通过逻辑：** 状态必须是 **所有** `activity_approver.status` 均为 `1`（通过），活动状态才变为"已通过"。
    3. **驳回逻辑：** **任意一位**审批人选择了**驳回**，活动状态应**立即**变为"已驳回"，并终止其他审批人的流程。
    4. **进度展示：** 在**活动详情页**的"审批面板"中，展示 `activity_approver` 表中每位审批人的"XXX 已通过/XX 未通过"状态。
+ **防重复提交：** 活动创建时添加防重复提交机制，避免多次点击创建多个相同活动。
+ **参与人员管理：** 参与人员信息包含完整的部门信息，确保数据完整性和一致性。
+ **系统界面优化：** 修复Echarts图表初始化问题，优化批量导入说明显示，更新系统Logo文本，完善数据导出下载功能。

#### 4.5. 活动附件管理
+ **功能概述：** 支持活动创建者上传相关文件（如活动方案、预算表、签到表等），并提供下载、删除、预览等操作。
+ **数据库设计：** 使用独立表 `activity_attachment` 存储附件信息，支持文件上传、下载、预览、删除等功能。
+ **文件类型限制：** 支持Office文档（doc, docx, xls, xlsx, ppt, pptx）、PDF、图片（jpg, jpeg, png, gif）、压缩包（zip, rar）。
+ **文件大小限制：** 单个文件最大10MB。
+ **权限控制：**
    - **上传权限：** 活动创建者、社长、副社长、部长（自己创建的活动）
    - **删除权限：** 附件上传者、活动创建者、社长、副社长、部长（自己创建的活动）
    - **下载权限：** 所有有权限查看活动的用户
+ **文件存储：** 本地文件系统，路径格式：`uploads/activity/{activityId}/{year}/{month}/{uuid}.{ext}`

#### 4.6. 统计与导出
+ **数据导出功能：**
    - **导出类型：** 支持部门信息、成员信息、活动信息导出
    - **导出格式：** Excel格式（.xlsx）、ZIP压缩包（包含多个Excel文件）
    - **导出模式：** 
        - 单选模式：用户选择一种类型时，自动导出Excel格式
        - 多选模式：用户选择多种类型时，自动导出ZIP格式（包含所有类型的Excel文件）
    - **权限控制：** 部长和副部长只能导出本部门成员信息
    - **部门信息导出：** 删除"部门ID"列，"负责人"列显示部长姓名，"联系方式"列显示部长电话号码
    - **成员信息导出：** 支持部门多选筛选，社长、副社长、指导老师可以导出全部成员
    - **活动信息导出：** 支持时间范围筛选，筛选逻辑：开始时间和结束时间都在范围内
+ **导出交接包：**
    - **PDF 内容：** 仅展示活动的基本信息（名称、时间、地点、类型、负责人、参与人名单）的**列表**，不含富文本简介或附件照片。
    - **ZIP 内容：** 包含README.txt说明文件和各类型Excel文件
    - **README优化：** 多选导出类型时，删去"导出ID"字段

### 5. 接口命名规范与错误码（不变）
（遵循 PRD 第 8、9 条）

### 6. 前端交互与界面规则（关键点）
+ **列表空态/删除操作/Toast 规则：** 遵循 PRD 第 6 条规定。
+ **分页参数：** 保存在 URL query，刷新保持页码与筛选条件。
+ **仪表盘：** 按角色展示不同的统计卡片、分布图（使用 ECharts）和快捷入口。
+ **个人中心：** 仅可编辑姓名、邮箱、手机号；部门/角色只读。
+ **审批进度展示：** 详情页审批面板展示（见 4.4）。

